"file","name","parameters","returns","side_effects","version","notes"
"config.py","Config","(dataclass; fields: data_root: str='data', out_root: str='out', state_root: str='state', universe: dict, data: dict, features: dict, ops: dict, expr: dict, fitness: dict, gp: dict, cache: dict, parallel: dict, logging: dict)","Config","NONE","v0.1","全局配置对象；字段名可在实现中扩展但需保持向后兼容；用于所有模块读取统一口径（股票池/窗口集/FAST→FULL门控/缓存预算/并行worker数/keep_last=252等）。"
"config.py","load_config","(path: str)","Config","READ_DISK","v0.1","从本地配置文件（建议YAML/JSON）加载Config；实现需做字段校验与默认值填充；失败模式：缺失关键字段/类型不匹配需抛明确异常。"
"config.py","dump_config","(cfg: Config, path: str)","None","WRITE_DISK","v0.1","将Config序列化落盘，供checkpoint引用；要求原子写入，避免中断导致配置损坏。 [HEURISTIC_FIX_NEEDS_REVIEW]"
"config.py","config_fingerprint","(cfg: Config)","str","NONE","v0.1","生成配置指纹（如sha256），用于manifest/checkpoint可追溯；指纹变化应触发缓存失效与增量保护。"
"run_mine.py","main","(argv: list[str] | None = None)","int","READ_DISK|WRITE_DISK|NETWORK","v0.1","主入口：增量拉数→构建/更新panel→(可选)物化缓存→GP round/gen→更新因子库→落盘+滚动维护+checkpoint；必须只处理新增交易日/新增round-gen，禁止全量重算。"
"run_mine.py","run_mining","(cfg: Config)","dict[str, Any]","READ_DISK|WRITE_DISK|NETWORK","v0.1","可被测试/外部调用的挖掘流程封装；返回本次run摘要（处理日期范围、round/gen、候选数量、入库数量、缓存命中率、耗时等）。"
"run_report.py","main","(argv: list[str] | None = None)","int","READ_DISK|WRITE_DISK","v0.1","研究复核入口：对因子库快照生成非交易报告（IC统计、分年、衰减、覆盖率、稳定性等），输出CSV/JSON/Markdown至少CSV；不得生成下单/调仓指令。"
"run_report.py","run_report","(cfg: Config, library_path: str)","dict[str, Any]","READ_DISK|WRITE_DISK","v0.1","对指定因子库快照进行复核；需严格按交易日对齐与样本过滤规则输出指标；失败模式：样本量不足/缺失率过高需记录并跳过。"
"scripts/download_data.py","main","(argv: list[str] | None = None)","int","READ_DISK|WRITE_DISK|NETWORK","v0.1","脚本入口：调用src/api与src/store完成一次性/增量下载原始数据，写入data/raw与data/metadata；必须幂等、可断点续跑。"
"scripts/download_data.py","download_incremental","(cfg: Config, start: str, end: str)","dict[str, Any]","READ_DISK|WRITE_DISK|NETWORK","v0.1","增量下载OHLCV/amount/复权/停牌/涨跌停/行业/市值等；只请求缺失交易日；写入分区文件并记录版本hash与字段映射。"
"scripts/build_panel.py","main","(argv: list[str] | None = None)","int","READ_DISK|WRITE_DISK","v0.1","脚本入口：从raw构建/更新panel(date×code)与基础特征到data/panel；要求增量更新与滚动保留(keep_last=252默认)。"
"scripts/build_panel.py","build_panel_incremental","(cfg: Config, start: str, end: str)","dict[str, Any]","READ_DISK|WRITE_DISK","v0.1","增量构建面板与基础特征；必须保证date×code对齐、字段dtype稳定、缺失/停牌处理符合data_contract；返回构建摘要（覆盖率、缺失率、耗时）。"
"scripts/plan_cache.py","main","(argv: list[str] | None = None)","int","READ_DISK|WRITE_DISK","v0.1","脚本入口：对指定表达式集合输出缓存计划(manifest)到out/cache_plan；不做物化。"
"scripts/plan_cache.py","plan_cache_for_library","(cfg: Config, expressions: list[str], budget_bytes: int)","dict[str, Any]","READ_DISK|WRITE_DISK","v0.1","缓存规划：识别公共子表达式hash→估计成本/存储→在预算约束下选取物化集合；manifest需包含失效规则（依赖的raw/panel版本与cfg_fingerprint）。"
"scripts/materialize_cache.py","main","(argv: list[str] | None = None)","int","READ_DISK|WRITE_DISK","v0.1","脚本入口：按manifest物化中间量到data/cache；输出命中率与节省估计。"
"scripts/materialize_cache.py","materialize_from_manifest","(cfg: Config, manifest_path: str)","dict[str, Any]","READ_DISK|WRITE_DISK","v0.1","读取manifest并逐项计算落盘；失败项需记录原因（缺失数据/数值错误/资源不足）；返回物化统计（成功率、耗时、bytes）。"
"scripts/export_library.py","main","(argv: list[str] | None = None)","int","READ_DISK|WRITE_DISK","v0.1","脚本入口：把当前因子库快照导出为独立CSV/JSON（expression+核心指标+hash+版本信息），便于下游复用或人工审查。"
"scripts/export_library.py","export_library_snapshot","(cfg: Config, snapshot_path: str, out_path: str)","None","WRITE_DISK","v0.1","导出指定快照；需保持字段稳定（expr, fitness, ic, icir, n, miss, max_corr, len, depth, created_at等）。"
"src/api/rate_limit.py","RateLimitError","(Exception)","RateLimitError","NONE","v0.1","API错误分类：限流/超时/网络错误；用于上层重试与降级。"
"src/api/rate_limit.py","with_retry","(fn: Callable[[], Any], *, max_tries: int = 5, backoff_s: float = 0.5, timeout_s: float = 30.0, retry_on: tuple[type[Exception], (cfg: Config)] = (Exception,))","Any","NONE","v0.1","通用重试包装器（指数退避可选）；实现需区分可重试与不可重试错误并记录日志；用于myquant_io统一容错。 [CONTRACT_NORMALIZED_V0_1_NEEDS_REVIEW]"
"src/api/rate_limit.py","RateLimiter","(per_second: float, burst: int = 1)","RateLimiter","NONE","v0.1","简单令牌桶节流器；用于控制外部数据源请求频率，避免被封；多进程场景下需注意进程间独立限流或集中限流策略。"
"src/api/myquant_io.py","MyQuantIO","(class; init(session: Any, *, timeout_s: float = 30.0))","MyQuantIO","NETWORK","v0.1","掘金SDK适配层对象；对外只暴露本项目内部希望的接口；实现时需根据MyQuant文档/用户提供的签名映射到真实参数名与字段。"
"src/api/myquant_io.py","create_myquant_io","(cfg: Config)","MyQuantIO","NETWORK","v0.1","根据cfg创建MyQuantIO（鉴权/环境/端点等）；失败模式：鉴权失败/网络不可用需抛明确异常并在run层终止或降级。"
"src/api/myquant_io.py","trade_days","(io: MyQuantIO, start: str, end: str, *, calendar: str = 'CN')","list[str]","NETWORK","v0.1","获取[start,end]交易日（YYYY-MM-DD）；必须稳定、可缓存；实现时需映射到数据源真实日历接口。"
"src/api/myquant_io.py","ohlcv","(io: MyQuantIO, symbols: list[str], start: str, end: str, *, fields: list[str] = ['open','high','low','close','volume','amount'], adj: str = 'none')","pd.DataFrame(date×code×field, float32/float64)","NETWORK","v0.1","拉取日频OHLCV/amount；adj为内部口径（none/pre/post等），实现需映射到MyQuant真实复权参数；需保证字段齐全、时区/交易日对齐。"
"src/api/myquant_io.py","index_members","(io: MyQuantIO, index: str, start: str, end: str, *, as_of: str = 'trade_date')","pd.DataFrame(date×code, bool)","NETWORK","v0.1","获取指数成分随时间变化（如CSI500）；返回成员矩阵或长表；用于滚动股票池构建。"
"src/api/myquant_io.py","industry_map","(io: MyQuantIO, symbols: list[str], start: str, end: str, *, scheme: str = 'SW_L1')","pd.DataFrame(date×code, category)","NETWORK","v0.1","行业分类映射（如申万一级）；用于中性化行业哑变量；需处理行业变更与缺失。"
"src/api/myquant_io.py","market_cap","(io: MyQuantIO, symbols: list[str], start: str, end: str, *, float_mcap: bool = True)","pd.DataFrame(date×code, float32)","NETWORK","v0.1","市值/流通市值时间序列；中性化使用ln(mcap)；需处理停牌/缺失并记录覆盖率。"
"src/calendar.py","get_trade_days","(io: MyQuantIO | None, start: str, end: str, *, calendar: str = 'CN')","list[str]","NETWORK","v0.1","交易日历工具：优先用io获取并落盘缓存；无io时从本地缓存读取；必须可重复与可追溯。"
"src/calendar.py","is_trade_day","(date: str, trade_days: list[str])","bool","NONE","v0.1","判断是否交易日；用于增量处理边界。"
"src/calendar.py","shift_trade_day","(date: str, n: int, trade_days: list[str])","str","NONE","v0.1","交易日位移（n可正负）；用于forward return对齐与窗口截取。"
"src/calendar.py","align_to_trade_days","(dates: list[str], trade_days: list[str], *, how: str = 'inner')","list[str]","NONE","v0.1","将任意日期序列对齐到交易日集合（inner/left等）；失败模式：非交易日映射规则需明确并记录。"
"src/universe.py","build_universe","(cfg: Config, trade_days: list[str], *, io: MyQuantIO | None = None)","pd.DataFrame(date×code, bool)","READ_DISK|WRITE_DISK|NETWORK","v0.1","构建股票池（默认CSI500滚动成分或全A过滤）；必须支持增量更新与滚动存储；过滤ST/上市天数/退市/暂停上市等。"
"src/universe.py","apply_universe_filters","(universe: pd.DataFrame, panel: pd.DataFrame, *, min_list_days: int = 126, exclude_st: bool = True)","pd.DataFrame(date×code, bool)","NONE","v0.1","统一过滤规则：上市天数、ST、缺失严重等；输出可交易mask并统计覆盖率。"
"src/universe.py","universe_roll_union","(members: pd.DataFrame, *, lookback_days: int = 20)","pd.DataFrame(date×code, bool)","NONE","v0.1","滚动并集股票池（用于平滑调入调出与提升覆盖）；需保证只依赖历史信息，避免前视。"
"src/store.py","DataStore","(class; init(root: str, *, lock_dir: str = 'state/locks'))","DataStore","READ_DISK|WRITE_DISK","v0.1","本地数据湖I/O：raw/panel/cache/metadata 读写；需原子写与文件锁；记录版本hash与构建参数；支持append+rolloff(keep_last=252)。"
"src/store.py","load_raw","(store: DataStore, key: str, start: str | None = None, end: str | None = None)","pd.DataFrame","READ_DISK","v0.1","读取raw分区数据（如ohlcv/industry/mcap等）；需按交易日裁剪并保证dtype稳定；缺失需显式。"
"src/store.py","save_raw","(store: DataStore, key: str, df: pd.DataFrame, *, version_tag: str, mode: str = 'append')","None",WRITE_DISK,"v0.1","写入raw数据；必须原子写+锁；mode=append用于增量；需更新metadata（字段、dtype、版本、来源、cfg_fingerprint）。 [SIDE_EFFECTS_NORMALIZED_NEEDS_REVIEW]"
"src/store.py","load_panel","(store: DataStore, key: str, start: str | None = None, end: str | None = None)","pd.DataFrame(date×code, float32/float64)","READ_DISK","v0.1","读取panel或派生特征面板；必须返回对齐的(date×code)结构。"
"src/store.py","save_panel","(store: DataStore, key: str, panel: pd.DataFrame, *, version_tag: str, mode: str = 'append', keep_last: int = 252)","None",WRITE_DISK,"v0.1","写入panel/特征；append并滚动保留keep_last；失败模式：日期不连续/重复需去重并记录。 [SIDE_EFFECTS_NORMALIZED_NEEDS_REVIEW]"
"src/store.py","load_cache","(store: DataStore, expr_hash: str, start: str | None = None, end: str | None = None)","pd.DataFrame(date×code, float32)","READ_DISK","v0.1","读取中间量缓存（按子表达式hash）；必须校验依赖版本/失效规则，不匹配则视为未命中。"
"src/store.py","save_cache","(store: DataStore, expr_hash: str, panel: pd.DataFrame, *, version_tag: str, keep_last: int = 252)","None",WRITE_DISK,"v0.1","落盘缓存中间量；需记录存储bytes、覆盖率、生成耗时，用于cache_planner成本校准。 [SIDE_EFFECTS_NORMALIZED_NEEDS_REVIEW]"
"src/store.py","list_available_dates","(store: DataStore, key: str)","list[str]","READ_DISK","v0.1","列出某数据键已落盘的交易日范围/分区，用于增量下载与增量构建判定。"
"src/features/registry.py","FeatureRegistry","(class; init())","FeatureRegistry","NONE","v0.1","特征注册表：feature_name→builder/loader/依赖声明；用于统一构建基础特征与后续扩展。"
"src/features/registry.py","register_feature","(reg: FeatureRegistry, name: str, builder: Callable[(cfg: Config), pd.DataFrame], *, requires: list[str] = [], cacheable: bool = True)","None","NONE","v0.1","注册特征；requires用于依赖追踪与增量构建；cacheable标记是否可落盘。 [CONTRACT_NORMALIZED_V0_1_NEEDS_REVIEW]"
"src/features/registry.py","build_features","(reg: FeatureRegistry, store: DataStore, names: list[str], start: str, end: str, *, overwrite: bool = False)","dict[str, pd.DataFrame]","READ_DISK|WRITE_DISK","v0.1","批量构建特征并共享中间数据；必须保证对齐(date×code)与dtype；overwrite=False时仅补齐缺失交易日。"
"src/features/registry.py","load_feature","(store: DataStore, name: str, start: str | None = None, end: str | None = None)","pd.DataFrame(date×code, float32/float64)","READ_DISK","v0.1","从data/panel读取已构建特征；缺失时由上层决定是否触发构建。"
"src/features/registry.py","create_default_feature_registry","(cfg: Config)","FeatureRegistry","NONE","v0.1","创建默认特征注册表（至少包含base_features定义的价量派生特征）；口径需与data_contract一致。"
"src/features/base_features.py","build_base_features","(store: DataStore, start: str, end: str, *, features: list[str] | None = None)","dict[str, pd.DataFrame(date×code, float32)]","READ_DISK|WRITE_DISK","v0.1","基于OHLCV/amount等生成日频基础特征（ret/lnret/range/turnover等）；需处理停牌/复权口径；输出落盘到data/panel。"
"src/features/base_features.py","list_base_features","()","list[str]","NONE","v0.1","返回内置基础特征名列表，供配置与注册表使用。"
"src/features/intraday_agg.py","aggregate_intraday_to_daily","(store: DataStore, start: str, end: str, *, rules: dict[str, Any])","dict[str, pd.DataFrame(date×code, float32)]","READ_DISK|WRITE_DISK","v0.1","（可选）分钟数据→日内聚合特征；聚合后只落日频结果，避免保存分钟全量；失败模式：分钟缺失/停牌需降级并记录。"
"src/ops/registry.py","OpRegistry","(class; init())","OpRegistry","NONE","v0.1","算子注册表：op_name→实现函数/输入输出约束/窗口参数约束/可缓存标记/成本模型标签；表达式引擎通过此表执行。"
"src/ops/registry.py","register_op","(reg: OpRegistry, name: str, fn: Callable[(cfg: Config), Any], *, arity: int, kind: str, params_spec: dict[str, Any], cacheable: bool = True, cost_tag: str = 'default')","None","NONE","v0.1","注册算子；kind∈{elementwise,cross_section,time_series}；params_spec需约束窗口常数位置（仅允许出现在指定参数位）。 [CONTRACT_NORMALIZED_V0_1_NEEDS_REVIEW]"
"src/ops/registry.py","get_op","(reg: OpRegistry, name: str)","Callable[dict[str, Any], Any]","NONE","v0.1","获取算子实现；若不存在需抛KeyError并在parser阶段提前拦截。 [CONTRACT_NORMALIZED_V0_1_NEEDS_REVIEW]"
"src/ops/registry.py","list_ops","(reg: OpRegistry, *, kind: str | None = None)","list[str]","NONE","v0.1","列出可用算子；用于随机生成表达式与合法性检查。"
"src/ops/registry.py","op_signature","(reg: OpRegistry, name: str)","dict[str, Any]","NONE","v0.1","返回算子签名/约束（arity、kind、参数限制、cacheable、cost_tag），供parser/canonicalize/GP约束使用。"
"src/ops/registry.py","create_default_op_registry","(cfg: Config)","OpRegistry","NONE","v0.1","创建默认算子集（elementwise/cross_section/time_series），并绑定安全数学实现；需包含PDF强调的窗口常数集合{1,5,10,20,40,60}等可配置集。"
"src/ops/safe_math.py","safe_div","(a: Any, b: Any, *, eps: float = 1e-12)","Any","NONE","v0.1","安全除法：避免除零/inf/nan；需对ndarray/Series/DataFrame兼容；用于表达式执行避免崩溃。"
"src/ops/safe_math.py","safe_log","(x: Any, *, eps: float = 1e-12)","Any","NONE","v0.1","安全log：对非正数做clip或置nan并记录；与缺失处理策略一致。"
"src/ops/safe_math.py","safe_sqrt","(x: Any, *, eps: float = 0.0)","Any","NONE","v0.1","安全sqrt：对负数处理；需与winsorize/zscore后数值范围兼容。"
"src/ops/safe_math.py","clip_inf_nan","(x: Any, *, nan_value: float = float('nan'), posinf_value: float = float('nan'), neginf_value: float = float('nan'))","Any","NONE","v0.1","统一清理inf/nan；表达式评估与fitness前都应调用并统计比例。"
"src/ops/elementwise.py","register_elementwise_ops","(reg: OpRegistry)","None","NONE","v0.1","注册逐元素算子（+ - * /、abs、log、rank-friendly非线性等）；具体实现内部可含helper不入契约。"
"src/ops/cross_section.py","register_cross_section_ops","(reg: OpRegistry)","None","NONE","v0.1","注册截面算子（rank、zscore、winsorize、group-neutral等）；按日横截面运算，必须处理缺失与样本量不足。"
"src/ops/time_series.py","register_time_series_ops","(reg: OpRegistry, *, allowed_windows: list[int])","None","NONE","v0.1","注册时序算子（rolling mean/std/min/max/corr/cov/ewm/delay/delta等）；窗口集必须受限（PDF强调常数窗口位置限制）。"
"src/ops/cost_model.py","estimate_op_cost","(op_name: str, signature: dict[str, Any], *, n_dates: int, n_codes: int)","float","NONE","v0.1","成本模型：估计某算子在给定面板规模下的计算成本，用于缓存规划与GP启发式（降低算力浪费）。"
"src/ops/cost_model.py","estimate_storage_bytes","(n_dates: int, n_codes: int, *, dtype: str = 'float32')","int","NONE","v0.1","估计单个(date×code)面板落盘字节数；供cache_planner预算约束。"
"src/expr/ast.py","ExprNode","(dataclass; fields: op: str, children: list['ExprNode'], params: dict[str, Any] = {}, leaf: str | None = None, const: float | None = None)","ExprNode","NONE","v0.1","表达式AST节点：op为算子名；leaf用于特征名；const用于常数；params包含窗口等；必须可序列化、可hash、可比较。"
"src/expr/ast.py","expr_to_string","(node: ExprNode)","str","NONE","v0.1","AST→规范表达式字符串（用于导出与复现）；需与parser互逆（round-trip）。"
"src/expr/ast.py","expr_complexity","(node: ExprNode)","dict[str, int]","NONE","v0.1","返回复杂度指标（node_count, depth等）；用于长度惩罚与反膨胀（超阈值可直接判无效）。"
"src/expr/parser.py","parse_expression","(expr: str, ops: OpRegistry, features: FeatureRegistry)","ExprNode","NONE","v0.1","表达式字符串→AST；函数式嵌套语法；必须做基本合法性检查（算子存在/arity匹配/窗口常数位置限制/特征存在）。"
"src/expr/parser.py","validate_expression","(node: ExprNode, ops: OpRegistry, features: FeatureRegistry)","None","NONE","v0.1","对AST做二次校验（类型/参数约束/禁止无意义运算）；失败模式需给可定位的错误信息（哪个子节点非法）。"
"src/expr/canonicalize.py","canonicalize_ast","(node: ExprNode, ops: OpRegistry)","ExprNode","NONE","v0.1","AST规范化：交换律排序、常数/窗口合法化、语义等价归一；用于去重与DAG合并；需保证幂等。"
"src/expr/canonicalize.py","canonical_hash","(node: ExprNode)","str","NONE","v0.1","返回规范化后的稳定hash（用于dedup/cache key）；必须跨进程/跨运行稳定（不依赖内存地址）。"
"src/expr/dag.py","ExprDAG","(class; fields: nodes: dict[str, ExprNode], roots: list[str], topo: list[str])","ExprDAG","NONE","v0.1","多表达式AST合并为DAG：公共子表达式按hash合并；topo为拓扑执行顺序；用于批量评估共享中间量。"
"src/expr/dag.py","build_dag","(roots: list[ExprNode])","ExprDAG","NONE","v0.1","从多个AST构建DAG；必须先canonicalize并合并；输出节点集与roots hash列表。"
"src/expr/evaluator.py","EvalStats","(TypedDict; keys: cache_hits: int, cache_misses: int, computed_nodes: int, seconds: float, failed_nodes: int)","type","NONE","v0.1","评估统计结构：用于日志与cache效果评估；实现中可扩展字段但需向后兼容。"
"src/expr/evaluator.py","ExpressionEvaluator","(class; init(ops: OpRegistry, store: DataStore, *, use_disk_cache: bool = True, memory_cache_max_items: int = 1024))","ExpressionEvaluator","READ_DISK|WRITE_DISK","v0.1","DAG执行器：给定(date,codes,panel)批量评估多个表达式共享中间量；支持内存缓存与落盘缓存；必须记录命中率与失败原因。"
"src/expr/evaluator.py","evaluate_many","(ev: ExpressionEvaluator, dag: ExprDAG, panel: dict[str, pd.DataFrame], dates: list[str], codes: list[str])","tuple[dict[str, pd.DataFrame(date×code, float32)], EvalStats]","READ_DISK|WRITE_DISK","v0.1","批量评估：panel为已加载特征面板字典；输出每个root的因子值面板；数值错误/样本不足需产生nan并记录failed_nodes。"
"src/neutralize/preprocess.py","winsorize_zscore_cs","(x: pd.DataFrame, *, lower_q: float = 0.01, upper_q: float = 0.99)","pd.DataFrame(date×code, float32)","NONE","v0.1","按日横截面清洗：winsorize(1%) + zscore；需处理缺失并输出覆盖率统计；这是fitness强制口径。"
"src/neutralize/preprocess.py","fill_missing_cs","(x: pd.DataFrame, *, method: str = 'median')","pd.DataFrame","NONE","v0.1","横截面缺失值填充（如中位数/0）；实现需记录填充比例；失败模式：有效样本太少则整日置nan。"
"src/neutralize/preprocess.py","coverage_stats","(x: pd.DataFrame, universe: pd.DataFrame | None = None)","dict[str, Any]","NONE","v0.1","覆盖率/缺失率统计（按日与总体）；用于FAST→FULL门控（缺失率过高直接跳过）。"
"src/neutralize/xsec_regress.py","build_neutral_design","(industry: pd.DataFrame, mcap: pd.DataFrame, *, add_intercept: bool = True)","dict[str, Any]","NONE","v0.1","构建中性化设计矩阵信息：行业哑变量 + ln(mcap)（至少）并可扩展风格因子；需保证与因子值同日同code对齐。"
"src/neutralize/xsec_regress.py","neutralize_cs","(x: pd.DataFrame, design: dict[str, Any], *, ridge_alpha: float = 1e-6)","tuple[pd.DataFrame(date×code, float32), dict[str, Any]]","NONE","v0.1","按日横截面Ridge回归取残差实现中性化；返回残差面板与诊断（R2、n、condition等）；失败模式：病态/样本不足则跳过并记录。"
"src/fitness/rank_ic.py","compute_forward_returns","(close: pd.DataFrame, *, horizon: int = 1)","pd.DataFrame(date×code, float32)","NONE","v0.1","计算forward return：对齐口径为t时点因子预测t→t+horizon收益；必须使用交易日shift避免前视；缺失/停牌需置nan。"
"src/fitness/rank_ic.py","compute_rank_ic_series","(factor: pd.DataFrame, fwd_ret: pd.DataFrame, universe: pd.DataFrame | None = None)","pd.Series(index=date, float)","NONE","v0.1","按日计算rankIC（横截面Spearman相关）；需过滤不可交易样本并处理ties；返回日序列。"
"src/fitness/rank_ic.py","compute_icir","(ic: pd.Series, *, annualization: int = 252)","float","NONE","v0.1","ICIR = mean(ic)/std(ic)*sqrt(annualization)；样本太少或std≈0需返回nan并记录。"
"src/fitness/rank_ic.py","summarize_ic","(ic: pd.Series, *, by_year: bool = True)","dict[str, Any]","NONE","v0.1","输出IC统计摘要（mean,std,icir,t-stat,n,分年等）；用于报告与因子库元数据。"
"src/fitness/penalties.py","length_penalty","(complexity: dict[str, int], *, max_nodes: int, max_depth: int, lambda_len: float = 0.01)","float","NONE","v0.1","长度/深度惩罚与硬阈值：超上限可直接判0；用于反膨胀（PDF强调避免公式膨胀）。"
"src/fitness/penalties.py","corr_penalty","(max_corr: float, *, soft_start: float = 0.3, hard_max: float = 0.5, lambda_corr: float = 1.0)","float","NONE","v0.1","相关性惩罚：max_corr>hard_max则fitness=0；soft区间线性/凸惩罚；用于控制同代/库内相关。"
"src/fitness/penalties.py","apply_penalties","(raw_fitness: float, *, len_pen: float, corr_pen: float)","float","NONE","v0.1","组合惩罚得到最终fitness；需保证非负并可解释；实现需记录各惩罚分量到metrics。"
"src/fitness/evaluator.py","FitnessEvaluator","(class; init(cfg: Config, store: DataStore, ev: ExpressionEvaluator), expressions: list[str])","FitnessEvaluator","READ_DISK|WRITE_DISK","v0.1","适应度评估器：实现FAST→FULL两阶段门控；输出统一metrics字典（ic、icir、n、miss、r2、penalties等）。 metrics keys: ic_mean, icir, n_days, miss_ratio, len, max_corr [HEURISTIC_FIX_NEEDS_REVIEW]"
"src/fitness/evaluator.py","evaluate_fast","(fe: FitnessEvaluator, expr: str, *, dates: list[str], codes: list[str], cfg: Config, expressions: list[str])","dict[str, Any]","READ_DISK|WRITE_DISK","v0.1","FAST阶段：用子样本/短窗/低成本近似快速筛；若覆盖率不足/缺失率过高/复杂度超限直接淘汰并记录原因。 metrics keys: ic_mean, icir, n_days, miss_ratio, len, max_corr [HEURISTIC_FIX_NEEDS_REVIEW]"
"src/fitness/evaluator.py","evaluate_full","(fe: FitnessEvaluator, expr: str, *, dates: list[str], codes: list[str], cfg: Config, expressions: list[str])","dict[str, Any]","READ_DISK|WRITE_DISK","v0.1","FULL阶段：全样本评估（清洗winsorize+zscore→中性化→rankIC/ICIR→惩罚）；需严格对齐t vs t→t+1收益。 metrics keys: ic_mean, icir, n_days, miss_ratio, len, max_corr [HEURISTIC_FIX_NEEDS_REVIEW]"
"src/fitness/evaluator.py","evaluate_many","(fe: FitnessEvaluator, exprs: list[str], *, dates: list[str], codes: list[str], stage: str = 'fast', cfg: Config, expressions: list[str])","list[dict[str, Any]]","READ_DISK|WRITE_DISK","v0.1","批量评估；应尽可能共享DAG中间量与缓存；返回与输入同序的metrics列表；失败表达式需写明error_code。 metrics keys: ic_mean, icir, n_days, miss_ratio, len, max_corr [HEURISTIC_FIX_NEEDS_REVIEW]"
"src/gp/operators.py","generate_random_expr","(ops: OpRegistry, features: FeatureRegistry, *, max_depth: int, rng_seed: int | None = None)","str","NONE","v0.1","随机生成合法表达式（函数式字符串）；必须遵守窗口常数位置限制与非法运算过滤；用于初始种群大生成再筛（PDF 3.1提升初始种群质量）。"
"src/gp/operators.py","mutate_expr","(expr: str, ops: OpRegistry, features: FeatureRegistry, *, max_depth: int, rng_seed: int | None = None)","str","NONE","v0.1","变异：子树替换/点变异等；需保持语法合法；失败模式：变异后非法需重试有限次数后返回原expr并标记。"
"src/gp/operators.py","crossover_expr","(expr_a: str, expr_b: str, *, rng_seed: int | None = None)","tuple[str, str]","NONE","v0.1","交叉：交换子树产生两个子代；需做深度/节点数裁剪以防膨胀。"
"src/gp/operators.py","enforce_constraints","(expr: str, ops: OpRegistry, *, max_nodes: int, max_depth: int)","str | None","NONE","v0.1","约束修剪：超复杂度则返回None（淘汰）或做hoist/cut；用于反膨胀与避免无效运算。"
"src/gp/selection.py","tournament_select","(population: list[str], fitness: list[float], *, tournament_size: int, rng_seed: int | None = None)","int","NONE","v0.1","锦标赛选择（PDF提到tournament_size权衡收敛速度与多样性）；返回被选中个体索引。"
"src/gp/selection.py","select_elites","(population: list[str], metrics: list[dict[str, Any]], *, k: int)","list[int]","NONE","v0.1","精英保留：按fitness排序选top-k；用于每代保留最优个体避免退化。"
"src/gp/selection.py","parent_child_compete","(parents: list[str], children: list[str], parent_metrics: list[dict[str, Any]], child_metrics: list[dict[str, Any]])","tuple[list[str], list[dict[str, Any]]]","NONE","v0.1","父子竞争机制：子不如父则保留父；并可额外保留未进化但优秀父代（PDF 3.2）；需控制重复率避免趋同。"
"src/gp/dedup.py","canonical_key","(expr: str, ops: OpRegistry, features: FeatureRegistry)","str","NONE","v0.1","表达式去重键：parse→canonicalize→hash；用于同代去重与跨轮候选去重。"
"src/gp/dedup.py","dedup_population","(population: list[str], *, keys: list[str] | None = None)","tuple[list[str], list[int]]","NONE","v0.1","去重并返回保留索引；需要记录重复率（PDF 3.3降低重复率/提升有效公式数量）。"
"src/gp/dedup.py","filter_by_bloat","(population: list[str], complexity: list[dict[str, int]], *, max_nodes: int, max_depth: int)","list[int]","NONE","v0.1","反膨胀过滤：复杂度超限直接淘汰；与length_penalty一致。"
"src/gp/corr_control.py","compute_factor_corr","(factors: list[pd.DataFrame], *, method: str = 'spearman')","np.ndarray(shape=(n,n), float32)","NONE","v0.1","计算因子间相关矩阵（基于面板展平或按日聚合）；用于同代/精英集相关性控制。"
"src/gp/corr_control.py","max_corr_to_set","(candidate: pd.DataFrame, selected: list[pd.DataFrame], *, method: str = 'spearman')","float","NONE","v0.1","计算候选与已选集合的最大相关；用于hard阈值淘汰与soft惩罚。"
"src/gp/corr_control.py","greedy_decorrelate","(candidates: list[dict[str, Any]], *, max_corr: float = 0.5, key: str = 'fitness')","list[dict[str, Any]]","NONE","v0.1","贪心去相关筛选：按key排序逐个纳入，若与已选max_corr超阈值则跳过；用于轮末因子库入库（PDF 3.6降低相关性）。"
"src/gp/factor_library.py","FactorLibrary","(class; init(max_size: int, *, max_corr: float = 0.5))","FactorLibrary","READ_DISK|WRITE_DISK","v0.1","因子库维护：跨轮累计候选→按fitness排序→贪心去相关入库→快照落盘与版本管理；不得包含交易指令。"
"src/gp/factor_library.py","update_library","(lib: FactorLibrary, candidates: list[dict[str, Any]])","dict[str, Any]","NONE","v0.1","合并候选并去重去相关后更新库；返回更新摘要（新增/淘汰/库内最大相关/覆盖率分布）。"
"src/gp/factor_library.py","save_library_snapshot","(lib: FactorLibrary, path: str, *, version_tag: str)","None","WRITE_DISK","v0.1","保存因子库快照到out/libraries；必须包含cfg_fingerprint、数据版本、创建时间、表达式hash等元数据。"
"src/gp/factor_library.py","load_library_snapshot","(path: str)","FactorLibrary","READ_DISK","v0.1","读取快照恢复库；用于run_report或断点续跑。"
"src/gp/evolution.py","EvolutionState","(TypedDict; keys: round_id: int, gen_id: int, population: list[str], metrics: list[dict[str, Any]], rng_state: Any, cfg_fingerprint: str)","type","NONE","v0.1","进化状态结构：用于checkpoint round/gen级保存与恢复；必须可json/pickle序列化。"
"src/gp/evolution.py","run_round","(cfg: Config, store: DataStore, fe: FitnessEvaluator, lib: FactorLibrary, *, round_id: int, start_gen: int = 0)","EvolutionState","READ_DISK|WRITE_DISK","v0.1","执行一轮多代进化：初始种群大生成再筛→每代评估/去重/父子竞争/精英保留/相关性控制/反膨胀→checkpoint；只处理新增round/gen。"
"src/gp/evolution.py","run_generation","(state: EvolutionState, cfg: Config, fe: FitnessEvaluator, *, dates: list[str], codes: list[str])","EvolutionState","READ_DISK|WRITE_DISK","v0.1","执行单代：评估（FAST→FULL门控）、去重、选择、交叉/变异、父子竞争、精英保留、相关性惩罚；返回更新state并写generation摘要到out/candidates。"
"src/gp/evolution.py","resume_from_checkpoint","(path: str)","EvolutionState","READ_DISK","v0.1","从state/checkpoints读取并恢复进化状态（含随机种子与配置快照引用）；若cfg_fingerprint不一致需拒绝或显式强制重跑。"
"src/cache_plan/planner.py","plan_cache_manifest","(exprs: list[str], ops: OpRegistry, features: FeatureRegistry, *, budget_bytes: int, n_dates: int, n_codes: int)","dict[str, Any]","NONE","v0.1","缓存规划器：AST→DAG→统计子表达式频次+成本模型+存储估计→在预算内选择物化集合；manifest需包含node_hash、freq、est_cost、est_bytes、deps_hash、invalidate_rules。"
"src/cache_plan/planner.py","write_manifest","(manifest: dict[str, Any], path: str)","None","WRITE_DISK","v0.1","将manifest写入out/cache_plan；需原子写；便于物化脚本与复现。"
"src/cache_plan/planner.py","load_manifest","(path: str)","dict[str, Any]","READ_DISK","v0.1","读取manifest；需校验schema版本与cfg_fingerprint一致。"
"src/cache_plan/materialize.py","materialize_manifest","(manifest: dict[str, Any], ev: ExpressionEvaluator, store: DataStore, panel: dict[str, pd.DataFrame], dates: list[str], codes: list[str])","dict[str, Any]","READ_DISK|WRITE_DISK","v0.1","按manifest逐项计算并落盘到data/cache；记录耗时、成功率、bytes与失败原因；必须遵守keep_last滚动。"
"src/cache_plan/materialize.py","materialize_one","(node_hash: str, dag: ExprDAG, ev: ExpressionEvaluator, *, start: str, end: str, codes: list[str])","dict[str, Any]","READ_DISK|WRITE_DISK","v0.1","物化单个子表达式hash；用于失败重试/分块；需输出命中/失败原因与产物路径。"
"src/parallel/executor.py","Executor","(class; abstract interface)","Executor","NONE","v0.1","并行端口抽象：业务层只依赖Executor接口；本机实现可多进程spawn兼容；未来可替换Ray/Dask而不改业务逻辑。"
"src/parallel/executor.py","Executor.submit","(self: Executor, fn: Callable[(cfg: Config), Any], args: tuple[Any, (cfg: Config)])","Any","NONE","v0.1","提交单任务并返回future/handle；具体future类型由实现决定但需支持result()语义。 [CONTRACT_NORMALIZED_V0_1_NEEDS_REVIEW]"
"src/parallel/executor.py","Executor.map","(self: Executor, fn: Callable[(cfg: Config), Any], items: list[Any], *, chunksize: int = 1)","list[Any]","NONE","v0.1","批量映射；实现需避免复制巨型面板：建议items为key/日期分片，worker内部从DataStore读取。 [CONTRACT_NORMALIZED_V0_1_NEEDS_REVIEW]"
"src/parallel/executor.py","Executor.shutdown","(self: Executor, *, wait: bool = True)","None","NONE","v0.1","关闭资源；run结束必须调用以回收进程。"
"src/parallel/local_pool.py","create_local_executor","(cfg: Config)","Executor","NONE","v0.1","创建本机多进程Executor实现；需spawn兼容；worker初始化应最小化全局状态，避免pickle大对象。"
"src/utils/logging.py","get_logger","(name: str = 'dfq_gp')","logging.Logger","WRITE_DISK","v0.1","统一日志：控制台+文件(out/logs/)；日志中需绑定run_id/round/gen上下文；必须支持step/loop_progress/metrics。"
"src/utils/logging.py","set_run_context","(logger: logging.Logger, *, run_id: str, round_id: int | None = None, gen_id: int | None = None)","None","NONE","v0.1","绑定上下文到logger（可用LoggerAdapter）；用于全链路可追溯日志。"
"src/utils/logging.py","log_step","(logger: logging.Logger, step: str, *, extra: dict[str, Any] | None = None)","None","NONE","v0.1","记录阶段性进度（下载/构建/评估/进化/入库/物化等）；要求结构化字段便于grep与统计。"
"src/utils/logging.py","log_metrics","(logger: logging.Logger, metrics: dict[str, Any], *, prefix: str = '')","None","NONE","v0.1","记录指标字典（ic/icir/n/miss/cache_hit等）；对浮点保留合理精度并避免日志膨胀。"
"src/utils/fileio.py","ensure_dir","(path: str)","None","WRITE_DISK","v0.1","确保目录存在；用于data/out/state子目录初始化；必须并发安全。"
"src/utils/fileio.py","atomic_write_text","(path: str, text: str, *, encoding: str = 'utf-8')","None","WRITE_DISK","v0.1","原子写入文本（写临时文件→fsync→rename）；用于manifest/checkpoint/report避免损坏。"
"src/utils/fileio.py","atomic_write_bytes","(path: str, data: bytes)","None","WRITE_DISK","v0.1","原子写入二进制；用于pickle checkpoint等。"
"src/utils/fileio.py","append_with_rolloff","(path: str, df: pd.DataFrame, *, keep_last: int = 252, key_cols: list[str] = ['date'])","pd.DataFrame","READ_DISK|WRITE_DISK","v0.1","追加写入并滚动保留：用于out/ts时序记录与panel增量；必须去重并按date排序；禁止全量重写。"
"src/utils/fileio.py","with_file_lock","(lock_path: str, *, timeout_s: float = 30.0)","contextmanager","READ_DISK|WRITE_DISK","v0.1","文件锁上下文：保护多进程写同一资源；失败模式：超时需抛异常并提示用户降低并行度。"
"src/utils/state.py","load_manifest","(path: str = 'state/manifest.json')","dict[str, Any]","READ_DISK","v0.1","读取运行manifest：已处理日期、round/gen、窗口、版本、随机种子、配置快照引用；用于增量与断点续跑。"
"src/utils/state.py","save_manifest","(manifest: dict[str, Any], path: str = 'state/manifest.json')","None","WRITE_DISK","v0.1","保存manifest；必须原子写；更新时需保持schema稳定并记录cfg_fingerprint。"
"src/utils/state.py","save_checkpoint","(state: EvolutionState, path: str)","None","WRITE_DISK","v0.1","保存round/gen checkpoint（含population/metrics/rng_state/cfg_fingerprint）；用于断点续跑；必须原子写。"
"src/utils/state.py","load_checkpoint","(path: str)","EvolutionState","READ_DISK","v0.1","加载checkpoint；必须校验与当前cfg_fingerprint/数据版本匹配，否则拒绝恢复或要求显式强制。"
"src/utils/filters.py","tradable_mask","(panel: dict[str, pd.DataFrame], *, include_limit: bool = False)","pd.DataFrame(date×code, bool)","NONE","v0.1","可交易样本过滤：停牌/无成交量/异常值/（可选）涨跌停；用于fitness与IC计算的样本一致性。"
"src/utils/filters.py","limit_move_mask","(close: pd.DataFrame, *, up_limit: float = 0.095, down_limit: float = -0.095)","pd.DataFrame(date×code, bool)","NONE","v0.1","涨跌停过滤mask（A股可配置）；阈值口径需在data_contract说明；用于样本剔除与覆盖率统计。"
"src/utils/filters.py","apply_mask","(x: pd.DataFrame, mask: pd.DataFrame)","pd.DataFrame","NONE","v0.1","将mask应用到面板（不可交易置nan）；必须保持对齐并统计被剔除比例。"
"src/utils/numerics.py","winsorize_cs","(x: pd.DataFrame, *, lower_q: float = 0.01, upper_q: float = 0.99)","pd.DataFrame","NONE","v0.1","按日横截面winsorize；供preprocess与可选ops使用；必须处理全nan/样本不足。"
"src/utils/numerics.py","zscore_cs","(x: pd.DataFrame)","pd.DataFrame","NONE","v0.1","按日横截面标准化；需处理std=0情形并记录。"
"src/utils/numerics.py","rank_cs","(x: pd.DataFrame, *, pct: bool = True)","pd.DataFrame","NONE","v0.1","按日横截面rank（可转[0,1]分位）；用于rankIC与部分算子。"
"src/utils/numerics.py","pairwise_corr","(a: pd.DataFrame, b: pd.DataFrame, *, method: str = 'spearman')","float","NONE","v0.1","计算两个因子面板的相关（对齐后展平或逐日聚合）；用于相关性惩罚与去相关筛选。"
